<!DOCTYPE html>

<html lang="en-US">

  <!-- meta information of doc -->
  <head>
    <title>missing's corner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../../assets/css/main.css">
    <link rel="stylesheet" type="text/css" href="../code.css">
    <link rel="icon" type="image/png" href="../../images/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
  </head>

  <body>

    <!-- banner at top of website -->
    <picture>
        <img src="../../images/banner.png" alt="Banner" style="width:100%;">
    </picture>

    <!-- navigation bar -->
    <div class="navbar">
        <a id="navleft" href="../../index.html">HOME</a>
        <a id="navleft" href="../../writeups.html">WRITE-UPS</a>
        <a id="navleft" href="../../code.html">CODE</a>
        <a id="navleft" href="../../resources.html">RESOURCES</a>
        <a id="navright" href="#">CREDITS</a>
        <a id="navright" href="#">ABOUT</a>
    </div>

    <div class="card">

        <!-- back button -->
        <a href="../../code.html" class="button">Back</a>
        
    <!-- HTML content generated from markdown -->
    <h2 id="format-string-attack">Format String Attack</h2>
    <p>A format string attack is when user supplied input is passed as the first argument to printf() or similar function. Because of the function&#39;s ability to take in a variable number of arguments and improper validation, this can be abused to read values of memory on the stack. In addition to this, values can also be written to memory. This can result in a program crash, alteration of critical values, and even code execution. One such technique is to overwrite the address of a function in the global offset table.</p>
    <p>Below are examples of the format functions that when misused, can result in a format string attack:</p>
    <ul>
    <li>fprintf()</li>
    <li>printf()</li>
    <li>sprintf()</li>
    <li>snprintf()</li>
    <li>vfprintf()</li>
    <li>vprintf()</li>
    <li>vsprintf()</li>
    <li>vsnprintf()</li>
    </ul>
    <p>The format parameters that have significant outcomes are:</p>
    <ul>
    <li>%x - Read data from the stack as hex values</li>
    <li>%s - Read character strings from memory</li>
    <li>%n - Write the number of characters to an address</li>
    </ul>
    <h3 id="-printf-and-the-stack"><em>printf()</em> and the stack</h3>
    <pre><code>
    printf(<span class="hljs-comment">"a = %d     b = %d     c = %d"</span>, a, b, c);
    
    // stack growing from high to low memory
    
    <span class="hljs-number">0x00</span>
             ^
             |          | address of string to be formatted |       printf will read
        stack growth    |             value of a            |       in this direction
          direction     |             value of b            |              |
                        |             value of c            |              <span class="hljs-type">V</span>
    <span class="hljs-number">0xFF</span>
    </code></pre><p><strong>Mitigation</strong></p>
    <p>When passing user-supplied input to a printf() function, it is important to supply the format code as the first argument.</p>
    <p><code>printf(&quot;%s&quot;, user_input);</code></p>
    <p>Additionally, there are compiler flags and tools to perform static code analysis to check for format strings and produce warnings at compile time.</p>
    <p>Address randomization is also a countermeasure that makes this attack more unreliable.</p>
    <p><strong>Vulnerable Code</strong></p>
    <pre><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
    
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">char</span> szBuffer[<span class="hljs-number">20</span>];
    <span class="hljs-keyword">int</span> x = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">int</span> y = <span class="hljs-number">40</span>;

    <span class="hljs-comment">// obtain user input</span>
    fgets(szBuffer, <span class="hljs-keyword">sizeof</span>(szBuffer), <span class="hljs-built_in">stdin</span>);

    <span class="hljs-comment">// vulnerable usage of printf()</span>
    <span class="hljs-built_in">printf</span>(szBuffer);
    <span class="hljs-comment">// mitigating code is to properly use printf("%s", szBuffer);</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
    </code></pre><p><strong>Program Output</strong></p>
    <pre><code>$ ./<span class="hljs-keyword">format</span>
    AAAA%x%x%x%x
    
    AAAA60201df7dd37902578257860201d
    </code></pre><p><strong>Format string attack stack</strong></p>
    <pre><code>
    printf(<span class="hljs-string">"AAAA%x%x%x%x"</span>);
    
    // stack growing from high to low memory
    
    0x00
             ^
             |<span class="hljs-string">          </span>|<span class="hljs-string"> address of szBuffer </span>|<span class="hljs-string">            printf will read
        stack growth    </span>|<span class="hljs-string">       unknown       </span>|<span class="hljs-string"> %x 1       in this direction
          direction     </span>|<span class="hljs-string">       unknown       </span>|<span class="hljs-string"> %x 2             </span>|
                        |<span class="hljs-string">       unknown       </span>|<span class="hljs-string"> %x 3             V
                        </span>|<span class="hljs-string">       unknown       </span>|<span class="hljs-string"> %x 4
          szBuffer      </span>|<span class="hljs-string">         AAAA        </span>|
                        |<span class="hljs-string">         %x%x        </span>|
                        |<span class="hljs-string">         %x%x        </span>|
    0xFF
    </code></pre><p>Further Reading:</p>
    <ul>
    <li><a href="http://www.cis.syr.edu/~wedu/Teaching/cis643/LectureNotes_New/Format_String.pdf">http://www.cis.syr.edu/~wedu/Teaching/cis643/LectureNotes_New/Format_String.pdf</a></li>
    </ul>
    
    </div>
    <!-- end of content -->

    <!-- footer with contact info -->
    <div class="footer">
        <a href="https://github.com/whoismissing" class="fa fa-github"></a>
        <a href="https://twitter.com/0xmissing" class="fa fa-twitter"></a>
        <a href="#" class="fa fa-linkedin"></a>
    </div>

    </body>

</html>