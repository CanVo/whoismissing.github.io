<!DOCTYPE html>

<html lang="en-US">

  <!-- meta information of doc -->
  <head>
    <title>missing's corner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../assets/css/main.css">
    <link rel="stylesheet" type="text/css" href="code.css">
    <link rel="icon" type="image/png" href="../images/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
  </head>

  <body>

    <!-- banner at top of website -->
    <picture>
        <img src="../images/banner.png" alt="Banner" style="width:100%;">
    </picture>

    <!-- navigation bar -->
    <div class="navbar">
        <a id="navleft" href="../index.html">HOME</a>
        <a id="navleft" href="../writeups.html">WRITE-UPS</a>
        <a id="navleft" href="../code.html">CODE</a>
        <a id="navleft" href="../resources.html">RESOURCES</a>
        <a id="navright" href="#">CREDITS</a>
        <a id="navright" href="#">ABOUT</a>
    </div>

    <div class="card">

        <!-- back button -->
        <a href="../code.html" class="button">Back</a>
        
    <!-- HTML content generated from markdown -->
<h2 id="stack-buffer-overflow">Stack buffer overflow</h2>
<p>A stack buffer overflow is a memory corruption flaw where memory on the stack is overwritten outside of the buffer due to a lack of bounds checking. This can result in a program crash, alteration of critical values, and even code execution.</p>
<p>There are several functions in the C standard for obtaining user input that are unsafe due to the lack of bounds checking of values.</p>
<p>These are:</p>
<ul>
<li>gets()</li>
<li>scanf()</li>
<li>strcpy()</li>
</ul>
<p>Additionally, there are C functions that operate on null terminated strings and perform no bounds checking.</p>
<p>These are:</p>
<ul>
<li>strcat()</li>
<li>sprintf()</li>
<li>vsprintf()</li>
</ul>
<p><strong>Mitigation</strong></p>
<p>The mitigating code is to utilize the C functions for obtaining user input that specify maximum length as well as by checking the bounds of an array before writing to a buffer. </p>
<p>Equivalent functions that check for length are:</p>
<ul>
<li>fgets()</li>
<li>fscanf()</li>
<li>strncpy() -&gt; strlcpy()</li>
<li>strncat()</li>
<li>snprintf()</li>
</ul>
<p>In specific cases, modifying the order of local variables declared will prevent those values from being overwritten though that does not prevent the overflowing capability. </p>
<p>Other protection mechanisms against buffer overflows implemented by compilers and operating systems include:</p>
<ul>
<li>Stack canaries</li>
<li>Address space layout randomization (ASLR)</li>
<li>Executable space protection (NX)</li>
</ul>
<p>However, in the right conditions, these protection mechanisms can be bypassed.</p>
<p><strong>Vulnerable Code</strong></p>
<h3 id="example-1-">Example 1:</h3>
<pre><code><span class="hljs-comment">// compile with gcc -z execstack -fno-stack-protector -m32 stack_overflow_1.c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>

<span class="hljs-comment">// stack buffer overflow example 1</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> iFlag = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> szBuffer[<span class="hljs-number">15</span>];
    <span class="hljs-comment">// int iFlag = 0;  </span>
    <span class="hljs-comment">// changing the declaration of iFlag to here will prevent it from being overwritten in this case; however, other memory is still being overwritten</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n Enter the password : \n"</span>);

    gets(szBuffer);

    <span class="hljs-comment">// mitigation: using a C function that checks for length</span>
    <span class="hljs-comment">// fgets(szBuffer, sizeof(szBuffer), stdin);</span>

    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(szBuffer, <span class="hljs-string">"password"</span>) == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span> (<span class="hljs-string">"\n Correct Password \n"</span>);
        iFlag = <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span> (<span class="hljs-string">"\n Wrong Password \n"</span>);
    }

    <span class="hljs-keyword">if</span>(iFlag != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span> (<span class="hljs-string">"\n If password was wrong, this should not print \n"</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><p><strong>Normal Program Output</strong></p>
<pre><code>$ ./stack_overflow_1

    Enter the password : <span class="hljs-type">password</span>

    Correct Password

    <span class="hljs-keyword">If</span> password was wrong, this should <span class="hljs-keyword">not</span> print 

$ ./stack_overflow_1

    Enter the password : <span class="hljs-type">wrongpassword</span>

    Wrong Password
</code></pre><p><strong>Overflow Program Output</strong></p>
<pre><code>$ ./stack_overflow_1

    Enter the password : <span class="hljs-type">AAAAAAAAAAAAAAAAAAAAAAAAAAA</span>

    Wrong Password

    <span class="hljs-keyword">If</span> password was wrong, this should <span class="hljs-keyword">not</span> print
</code></pre><h3 id="example-2-">Example 2:</h3>
<pre><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printFlag</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"This function is not called by main\n"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">char</span> szBuffer[<span class="hljs-number">15</span>];

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n Hi, what's your name?\n"</span>);

    gets(szBuffer);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n It's nice to meet you %s\n"</span>, szBuffer);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
    </div>
    <!-- end of content -->

    <!-- footer with contact info -->
    <div class="footer">
        <a href="https://github.com/whoismissing" class="fa fa-github"></a>
        <a href="https://twitter.com/0xmissing" class="fa fa-twitter"></a>
        <a href="#" class="fa fa-linkedin"></a>
    </div>

    </body>

</html>